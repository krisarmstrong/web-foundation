name: Secret Rotation Reminder

on:
  schedule:
    # Run quarterly on the 1st of Jan, Apr, Jul, Oct at 9am UTC
    - cron: '0 9 1 1,4,7,10 *'
  workflow_dispatch: # Allow manual trigger

permissions:
  issues: write
  contents: read

jobs:
  create-rotation-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: Create rotation reminder issue
        uses: actions/github-script@v8
        with:
          script: |
            const quarter = Math.floor((new Date().getMonth()) / 3) + 1;
            const year = new Date().getFullYear();

            const title = `Q${quarter} ${year} Secret Rotation Reminder`;

            const body = `## Quarterly Secret Rotation Checklist

            It's time for the quarterly secret rotation review! Please complete the following tasks:

            ### NPM Token
            - [ ] Review NPM token age (rotate if >90 days)
            - [ ] Generate new NPM token if needed
            - [ ] Update GitHub secret \`NPM_TOKEN\`
            - [ ] Test publishing workflow
            - [ ] Revoke old token

            ### Formspree Endpoints
            - [ ] Review Formspree endpoint security
            - [ ] Rotate if any security concerns
            - [ ] Update all project .env files
            - [ ] Test contact forms on all sites

            ### Analytics Keys
            - [ ] Review Google Analytics measurement IDs
            - [ ] Review Plausible analytics keys
            - [ ] Rotate annually or if compromised
            - [ ] Test analytics tracking

            ### Security Review
            - [ ] Review recent Gitleaks scan results
            - [ ] Audit who has access to GitHub secrets
            - [ ] Check for any security incidents
            - [ ] Update rotation documentation if needed

            ### Documentation
            - [ ] Update \`.github/SECRET_ROTATION.md\` rotation table
            - [ ] Record rotation dates
            - [ ] Note any issues encountered

            ## Resources

            See [\`.github/SECRET_ROTATION.md\`](.github/SECRET_ROTATION.md) for detailed rotation procedures.

            ## Completion

            Once all tasks are complete, close this issue and document completion date.

            ---
            ðŸ¤– This issue was automatically created by the Secret Rotation Reminder workflow.
            `;

            // Check if a similar issue already exists
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automation'
            });

            const alreadyExists = existingIssues.some(issue =>
              issue.title.includes(`Q${quarter} ${year}`)
            );

            if (!alreadyExists) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'automation', 'secret-rotation']
              });
              console.log(`Created issue: ${title}`);
            } else {
              console.log(`Issue for Q${quarter} ${year} already exists, skipping creation`);
            }

  audit-secrets-access:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Audit secret patterns
        run: |
          echo "## Secret Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Variable Patterns" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find .env.example files
          if find . -name ".env.example" -type f | grep -q .; then
            echo "Found .env.example files:" >> $GITHUB_STEP_SUMMARY
            find . -name ".env.example" -type f >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No .env.example files found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### gitignore Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check .gitignore for secret patterns
          if grep -q ".env" .gitignore 2>/dev/null; then
            echo "âœ… .env files are ignored" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ .env files may not be ignored!" >> $GITHUB_STEP_SUMMARY
          fi

          if grep -q "*.key" .gitignore 2>/dev/null; then
            echo "âœ… .key files are ignored" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ .key files may not be ignored" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- Review .gitignore for comprehensive secret patterns" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure all .env files are template-only" >> $GITHUB_STEP_SUMMARY
          echo "- Use GitHub Secrets for CI/CD credentials" >> $GITHUB_STEP_SUMMARY
          echo "- See .github/SECRET_ROTATION.md for best practices" >> $GITHUB_STEP_SUMMARY
